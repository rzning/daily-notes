# JavaScript 单线程运行机制

JavaScript 代码的执行一大特点是单线程，在同一时间只能做一件事。

为利用多核 CPU 的计算能力 HTML5 提出 Web Worker 标准，允许 JavaScript 脚本创建多个线程，
但是子线程完全受主线程控制，且不得操作 DOM ，这一标准并没有改变 JavaScript 单线程的本质。


## 进程和线程

- 进程是 CPU 资源分配的最小单位，是能拥有资源和独立运行的最小单位，系统会给进程分配内存。
- 线程是 CPU 调度的最小单位，线程是建立在进程基础之上的一次程序运行单位，一个进程可以含有多个线程。

## 浏览器进程

- 浏览器是多进程的。
- 浏览器之所以能够运行，是因为系统给它的进程分配了资源，如 CPU 、内存等。
- 每打开一个 Tab 页签，浏览器都会创建一个独立浏览器进程，以获取相应 CPU 和内存资源。

浏览器主要包括以下进程：

- Browser 进程
  - 即浏览器主进程，负责协调和主控，只有一个。
  - 负责浏览器界面显示，与用户交互。如前进、后退等
  - 负责各个页面的管理，创建和销毁其他进程
  - 将 Renderer 进程得到的内存中的 Bitmap 绘制到用户界面上
  - 网络资源的管理、下载等
- 第三方插件进程
  - 每种类型的插件对应一个进程，仅当使用该插件时才创建。
- GPU 进程
  - 最多一个，用于 3D 渲染
- Renderer 进程
  - 浏览器渲染进程，即浏览器内核，内部是多线程的
  - 默认每个 Tab 页面一个进程，互不影响，用于页面渲染、脚本执行、事件处理等

### 浏览器内核 -- 渲染进程

可以说页面的渲染、脚本的执行、事件的循环等，都离不开渲染进程。

浏览器的渲染进程是多线程的，主要包括以下常驻线程：

- GUI 渲染线程
  - 负责渲染浏览器界面，解析 HTML, CSS 、构建 DOM 树和 RenderObject 树、布局和绘制等。

- JS 引擎线程
  - 负责处理 JavaScript 脚本，
  - 一个 Tab 页面 ( Renderer 进程 ) 只会有一个 JS 线程。

- 事件触发线程
  - 属于浏览器而不是 JS 引擎，用来控制事件循环。
  - 当 JS 引擎执行代码逻辑（如调用 `setTimeout()` 等方法）时，或可来自浏览器内核的其他线程（如鼠标点击、Ajax 异步请求等），会将对应任务添加到事件线程中。
  - 当对应事件被触发时，该线程会将事件添加到待处理队列的尾部，等待 JS 引擎处理。
  - 由于 JS 引擎为单线程，因此待处理队列中的任务只能等待被依次处理。

- 定时器触发器线程
  - 浏览器中的计数器功能由独立线程控制。
  - W3C 在 HTML 标准中规定 `setTimeout()` 低于 4ms 间隔时以 4ms 计。

- 异步 HTTP 请求线程
  - 浏览器在发起 `XMLHttpRequest` 请求时，将新开一个线程控制。
  - 当异步线程产生状态变更事件时，将回调放入事件队列。

其中 GUI 渲染线程与 JS 引擎线程是互斥的，若 JS 执行耗时则会导致页面渲染阻塞。

由于 JavaScript 可操作 DOM ，为防止渲染出现不可预期结果，
在 JS 引擎执行时 GUI 线程将挂起，GUI 更新则会被加入队列等待 JS 引擎空闲时立即被执行。

### WebWorker

为缓解 JS 引擎当线程任务执行压力，可以使用 WebWorker 机制创建子线程来执行与 DOM 渲染无关的耗时逻辑。

JS 主线程与 Worker 线程之间使用 postMessage API 进行通信。

WebWorker 与 SharedWorker 有以下区别：

- WebWorker 只属于单个 Tab 页面
- SharedWorker 是浏览器所有页面共享的

### 浏览器渲染流程

> 浏览器输入 url，浏览器主进程接管，开一个下载线程，然后进行 http 请求，然后等待响应，
> 获取内容，随后将内容通过 RendererHost 接口转交给 Renderer 进程 - 浏览器渲染流程开始




## JavaScript 单线程

所谓单线程是指，在 JavaScript 引擎中负责解析和执行 JavaScript 代码的线程只有一个，
通常将其称为 JavaScript 主线程。

实际上还存在其他的线程。如浏览器中处理 Ajax 请求的线程、处理 DOM 事件的线程、定时器线程，
Node.js 中读写文件的线程。此类线程可称为工作线程。

## 异步过程

在 JavaScript 主线程中调用异步函数后，将通知工作进程开始工作，主线程继续执行主线程相关逻辑。

在工作线程中需要执行异步任务，执行完后将通知主线程执行相应事件回调。

一个完整的异步过程通常有以下步骤：

1. 主线程发起一个异步请求
2. 相应的工作线程接收请求并告知主线程已收到
3. 主线程继续执行后续代码，同时工作线程执行异步任务
4. 工作线程完成工作后，通知主线程
5. 主线程收到通知，执行相应的回调函数

## 消息队列 & 事件循环

在异步过程中，工作线程在异步操作完成后需要通知主线程。

其中的通知机制是通过消息队列和事件循环实现的。

> **工作线程执行完成后将消息放到消息队列，主线程通过事件循环去取消息**

通常，主线程只会做一件事，即从消息队列里取消息并执行消息，然后再取消息再执行。
当消息队列为空时，就主线程就会等待，直到消息队列变为非空。

并且，主线程每次只处理一条消息，只有在当前消息执行完成后才会取下一个消息。

这里所谓的消息，一般指的是注册异步任务时添加的回调函数。

异步过程的回调函数，一定不在当前这一轮事件循环中执行。

从生产者与消费者的角度看，异步过程中工作线程是生产者，主线程是唯一消费者。

- 工作线程执行异步任务，执行完成后把相应的回调函数封装成一条消息放到消息队列中。
- 主线程不断地从消息队列中取消息并执行。
- 当消息队列为空时，主线程阻塞，直到消息队列再次非空。


## 参考

- [JavaScript 运行机制详解：再谈Event Loop - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)
- [【第993期】总是一知半解的Event Loop - 孙宇辉 - 前端早读课](https://mp.weixin.qq.com/s/3-8kH1L-FZqSgv8zocoY7g)
- [【第1091期】JavaScript：理解同步、异步和事件循环 - manxisuo - 前端早读课](https://mp.weixin.qq.com/s/k_85P8uzs0giLlVbX_Ow1w)
- [【第1219期】从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理 - 撒网要见鱼 前端早读课](https://mp.weixin.qq.com/s/vIKDUrbuxVNQMi_g_fiwUA)
